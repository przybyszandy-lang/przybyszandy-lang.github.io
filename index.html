<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F63ZRL5GBH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F63ZRL5GBH');
</script>

  <meta charset="UTF-8" />
  <title>Donkey App Jokes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.png" type="image/png">

  <meta name="theme-color" content="#0b3d91">

  <!-- iOS home screen icon + standalone mode -->
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- NEW -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <div id="languageBar">
    <span class="langs">
      <a href="#" data-lang="English"><img class="flag" src="english.png" alt="English"></a>
      <span class="sep">|</span>
      <a href="#" data-lang="Polish"><img class="flag" src="polish.png" alt="Polish"></a>
      <span class="sep">|</span>
      <a href="#" data-lang="German"><img class="flag" src="german.png" alt="German"></a>
      <span class="sep">|</span>
      <a href="#" data-lang="Spanish"><img class="flag" src="spanish.png" alt="Spanish"></a>
      <span class="sep">|</span>
      <a href="#" data-lang="French"><img class="flag" src="french.png" alt="French"></a>
    </span>
  </div>

  <div id="termsNote">
    <span id="termsText">By clicking 'Press me to get a joke' you agree to these</span>
    <a id="termsLinkConditions" href="conditions.html">Terms and Conditions</a>,
    <a id="termsLinkCookies" href="cookies.html">Use of Cookies</a>
    <span id="termsAnd">and</span>
    <a id="termsLinkPrivacy" href="privacy.html">Privacy Policy</a>.
  </div>
  
<div id="logoContainer">
  <img id="appLogo" src="icon-512.png" alt="Donkey Logo">
</div>
  
  <div class="btnRow">
    <button id="prevButton" disabled style="display:none;">Previous</button>
    <button id="mainButton">Press me to get a joke</button>
    <button id="copyButton" disabled style="display:none;">Copy Joke</button>
  </div>

  <div id="errorBox"></div>
  <div id="copyToast"></div>

  <div id="content">
    <div id="joke"></div>
    <div id="ratingIcons"></div>
    <div id="voteMessage">Thanks for your vote.</div>

    <div class="bottomRow">
      <button id="copyButtonBottom" disabled style="display:none;">Copy Joke</button>
    </div>

    <div id="extras">
      <a id="addJokeLink" href="addajoke.html">Want to add a joke?</a>
    </div>
  </div>

  <script src="i18n.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const { t, getLang, setLang } = window.DonkeyI18n;

      // ---------- STATE ----------
      let currentLang = getLang();
      let jokesCache = [];
      let currentJoke = null;
      let initialised = false;
      let voteLocked = false;

      let recentJokeIds = [];
      const RECENT_LIMIT = 20;

      let history = [];
      let historyIndex = -1;

      // ---------- DOM ----------
      const mainButton = document.getElementById('mainButton');
      const prevButton = document.getElementById('prevButton');
      const copyButton = document.getElementById('copyButton');
      const copyButtonBottom = document.getElementById('copyButtonBottom');
      const contentDiv = document.getElementById('content');
      const jokeDiv = document.getElementById('joke');
      const ratingIconsDiv = document.getElementById('ratingIcons');
      const voteMessageDiv = document.getElementById('voteMessage');
      const languageBar = document.getElementById('languageBar');
      const errorBox = document.getElementById('errorBox');
      const copyToast = document.getElementById('copyToast');
      const termsNote = document.getElementById('termsNote');
      
if (window.matchMedia("(display-mode: standalone)").matches) {
  termsNote.style.display = "none";
  languageBar.style.display = "none";
}

      const showLangLabel = document.getElementById('showLangLabel');
      const addJokeLink = document.getElementById('addJokeLink');

      const termsText = document.getElementById('termsText');
      const termsLinkConditions = document.getElementById('termsLinkConditions');
      const termsLinkCookies = document.getElementById('termsLinkCookies');
      const termsLinkPrivacy = document.getElementById('termsLinkPrivacy');
      const termsAnd = document.getElementById('termsAnd');

      // ---------- HELPERS ----------
      function applyHtmlLang() {
        document.documentElement.lang =
          currentLang === 'Polish' ? 'pl' :
          currentLang === 'German' ? 'de' :
          currentLang === 'Spanish' ? 'es' :
          currentLang === 'French' ? 'fr' : 'en';
      }

      function showError(msg) {
        console.error(msg);
        errorBox.style.display = 'block';
        errorBox.textContent = String(msg);
      }

      function clearError() {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
      }

      function showToast(msg) {
        copyToast.textContent = msg;
        copyToast.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => {
          copyToast.style.display = 'none';
        }, 1600);
      }

      function updatePrevButton() {
        prevButton.disabled = historyIndex <= 0;
      }

      function updateCopyButtons() {
        const enabled = !!(currentJoke && currentJoke.content);
        copyButton.disabled = !enabled;
        copyButtonBottom.disabled = !enabled;
      }

      function applyStaticTranslations() {
        applyHtmlLang();

        showLangLabel.textContent = t('show_lang', currentLang);

        prevButton.textContent = t('previous', currentLang);
        copyButton.textContent = t('copy_joke', currentLang);
        copyButtonBottom.textContent = t('copy_joke', currentLang);

        addJokeLink.textContent = t('add_joke', currentLang);

        termsText.textContent = t('terms_note', currentLang);
        termsLinkConditions.textContent = t('terms_link_conditions', currentLang);
        termsLinkCookies.textContent = t('terms_link_cookies', currentLang);
        termsLinkPrivacy.textContent = t('terms_link_privacy', currentLang);

        // optional: translate "and" nicely (fallback to "and")
        termsAnd.textContent =
          currentLang === 'Polish' ? 'i' :
          currentLang === 'German' ? 'und' :
          currentLang === 'Spanish' ? 'y' :
          currentLang === 'French' ? 'et' : 'and';

        // main button label depends on state
        mainButton.textContent = initialised
          ? t('press_next', currentLang)
          : t('press_first', currentLang);
      }

      // ---------- LANGUAGE SWITCH ----------
      document.querySelectorAll('#languageBar a[data-lang]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          setLang(a.dataset.lang);
        });
      });

      window.addEventListener('donkey:langchange', async (e) => {
        currentLang = e.detail.lang;

        // reset history so Previous doesnâ€™t mix languages
        recentJokeIds = [];
        history = [];
        historyIndex = -1;
        updatePrevButton();
        updateCopyButtons();

        applyStaticTranslations();

        // reload jokes if already started
        if (initialised) {
          await loadJokes();
        }
      });

      // ---------- SUPABASE ----------
      if (!window.supabase || !window.supabase.createClient) {
        showError('Supabase library did not load. Check your internet connection or the CDN link.');
        return;
      }

      const { createClient } = window.supabase;
      const client = createClient(
        'https://mknsvxajrvdlwqywvlrf.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rbnN2eGFqcnZkbHdxeXd2bHJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzE5ODIsImV4cCI6MjA4MTA0Nzk4Mn0.2urjAD5bb20Y73ZuWffeyfjDjoj7ISsowMRq9iYm-xo'
      );

      // ---------- RATING ----------
      const ratingOptions = [
        { key: 'rating_dont_get_it_count', img: '1.png' },
        { key: 'rating_ehh_count', img: '2.png' },
        { key: 'rating_good_one_count', img: '3.png' },
        { key: 'rating_fell_off_chair_count', img: '4.png' }
      ];

      function renderRatingIcons() {
        ratingIconsDiv.innerHTML = '';
        ratingOptions.forEach(opt => {
          const img = document.createElement('img');
          img.src = opt.img;
          img.alt = opt.key;
          img.onclick = () => rateJoke(opt.key);
          ratingIconsDiv.appendChild(img);
        });
      }

      // ---------- WEIGHTED RANDOM ----------
      const MAX_AVG = 4;

      function weightFromAverage(j) {
        const avg = Number(j && j.average);
        const safeAvg = Number.isFinite(avg) ? avg : 0;
        const clamped = Math.max(0, Math.min(MAX_AVG, safeAvg));
        const baseline = 1;
        const strength = 2;
        return baseline + Math.pow(clamped, strength);
      }

      function pickWeighted(arr, weightFn) {
        if (!arr || arr.length === 0) return null;

        let total = 0;
        const weights = new Array(arr.length);

        for (let i = 0; i < arr.length; i++) {
          const w = Math.max(0, Number(weightFn(arr[i])) || 0);
          weights[i] = w;
          total += w;
        }

        if (total <= 0) return arr[Math.floor(Math.random() * arr.length)];

        let r = Math.random() * total;
        for (let i = 0; i < arr.length; i++) {
          r -= weights[i];
          if (r <= 0) return arr[i];
        }
        return arr[arr.length - 1];
      }

      // ---------- COPY ----------
      async function copyCurrentJoke() {
        if (!currentJoke || !currentJoke.content) return;

        const textToCopy = `${currentJoke.content}\n\nfound at donkeyapp.com`;

        if (navigator.clipboard && window.isSecureContext) {
          try {
            await navigator.clipboard.writeText(textToCopy);
            showToast(t('copied', currentLang));
            return;
          } catch (e) {}
        }

        try {
          const ta = document.createElement('textarea');
          ta.value = textToCopy;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          ta.style.top = '0';
          document.body.appendChild(ta);
          ta.select();
          ta.setSelectionRange(0, ta.value.length);
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);

          if (ok) showToast(t('copied', currentLang));
          else showToast(t('copy_failed', currentLang));
        } catch (e) {
          showToast(t('copy_failed', currentLang));
        }
      }

      // ---------- RENDER / HISTORY ----------
      function renderJoke(joke, addToHistory) {
        if (!joke) return;

        currentJoke = joke;
        jokeDiv.textContent = currentJoke.content;

        voteLocked = false;
        voteMessageDiv.style.display = 'none';
        voteMessageDiv.textContent = t('thanks_vote', currentLang);

        renderRatingIcons();

        if (addToHistory) {
          if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
          }
          history.push(currentJoke);
          historyIndex = history.length - 1;
        }

        updatePrevButton();
        updateCopyButtons();
      }

      function showNextWeightedJoke() {
        if (!jokesCache.length) return;

        if (recentJokeIds.length >= jokesCache.length - 1) recentJokeIds = [];

        const candidates = jokesCache.filter(j => !recentJokeIds.includes(j.id));
        const picked = pickWeighted(candidates.length ? candidates : jokesCache, weightFromAverage);
        if (!picked) return;

        recentJokeIds.push(picked.id);
        if (recentJokeIds.length > RECENT_LIMIT) recentJokeIds.shift();

        renderJoke(picked, true);
      }

      function showPreviousJoke() {
        if (historyIndex <= 0) return;
        historyIndex -= 1;
        renderJoke(history[historyIndex], false);
      }

      // ---------- LOAD ----------
      async function loadJokes() {
        clearError();
        jokeDiv.textContent = t('loading', currentLang);

        const { data, error } = await client
          .from('jokes')
          .select('*')
          .eq('is_visible', true)
          .eq('is_flagged', false)
          .eq('language', currentLang)
          .limit(1000);

        if (error) {
          showError('Error loading jokes:\n' + (error.message || JSON.stringify(error)));
          jokeDiv.textContent = t('error_loading', currentLang);
          return;
        }

        jokesCache = data || [];
        if (!jokesCache.length) {
          jokeDiv.textContent = t('no_jokes', currentLang);
          return;
        }

        showNextWeightedJoke();
      }

      // ---------- VOTE ----------
      function incrementLocalCountAndAverage(jokeObj, ratingKey) {
        jokeObj[ratingKey] = (jokeObj[ratingKey] || 0) + 1;

        const c1 = Number(jokeObj.rating_dont_get_it_count) || 0;
        const c2 = Number(jokeObj.rating_ehh_count) || 0;
        const c3 = Number(jokeObj.rating_good_one_count) || 0;
        const c4 = Number(jokeObj.rating_fell_off_chair_count) || 0;

        const total = c1 + c2 + c3 + c4;
        if (total <= 0) {
          jokeObj.average = 0;
          return;
        }

        jokeObj.average = (1*c1 + 2*c2 + 3*c3 + 4*c4) / total;
      }

      async function rateJoke(ratingKey) {
        if (voteLocked || !currentJoke) return;
        voteLocked = true;

        voteMessageDiv.style.display = 'inline-block';
        voteMessageDiv.textContent = t('thanks_vote', currentLang);

        incrementLocalCountAndAverage(currentJoke, ratingKey);
        const newValue = currentJoke[ratingKey] || 0;

        const { error } = await client
          .from('jokes')
          .update({ [ratingKey]: newValue })
          .eq('id', currentJoke.id);

        if (error) {
          showError('Vote failed:\n' + (error.message || JSON.stringify(error)));
          voteMessageDiv.textContent = t('vote_failed', currentLang);
          voteLocked = false;
          return;
        }
      }

      // ---------- BUTTONS ----------
      prevButton.onclick = () => {
        if (!initialised) return;
        showPreviousJoke();
      };

      copyButton.onclick = () => {
        if (!initialised) return;
        copyCurrentJoke();
      };

      copyButtonBottom.onclick = () => {
        if (!initialised) return;
        copyCurrentJoke();
      };

      mainButton.onclick = async () => {
        if (!initialised) {

const logo = document.getElementById("appLogo");
logo.style.width = "90px";
document.getElementById("logoContainer").style.marginTop = "10px";

          initialised = true;

          // hide the terms note after first click (start page only)
          termsNote.style.display = 'none';

          contentDiv.style.display = 'block';
          languageBar.style.display = 'block';
          prevButton.style.display = 'inline-block';
          copyButton.style.display = 'inline-block';
          copyButtonBottom.style.display = 'inline-block';

          applyStaticTranslations(); // sets press_next + other labels
          await loadJokes();
        } else {
          showNextWeightedJoke();
        }
      };

      // ---------- INIT ----------
      applyStaticTranslations();
    });
  </script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.error("SW registration failed:", err));
    });
  }
</script>
  
</body>
</html>
