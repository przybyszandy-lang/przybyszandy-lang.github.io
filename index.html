<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>One Button Joke Site</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px 15px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      margin-bottom: 24px;
      font-size: 26px;
    }
    button {
      padding: 10px 22px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f7f7f7;
    }
    #joke { margin-top: 30px; font-size: 18px; line-height: 1.5; white-space: pre-line; min-height: 80px; }
    #meta { margin-top: 8px; font-size: 12px; color: #666; }
    #ratingSection { margin-top: 24px; font-size: 14px; }
    #ratingButtons button { margin: 2px; font-size: 13px; padding: 6px 10px; }
    #ratingStats { margin-top: 8px; font-size: 13px; color: #444; }
    textarea, input[type="email"] { width: 100%; box-sizing: border-box; padding: 8px; }
  </style>
</head>
<body>
  <h1>Press the button for a joke</h1>
  <button id="jokeButton">Tell me a joke</button>

  <div id="joke"></div>
  <div id="meta"></div>

  <div id="ratingSection">
    <div style="margin-bottom:4px;">Rate this joke:</div>
    <div id="ratingButtons"></div>
    <div id="ratingStats"></div>
  </div>

  <h2>Add a joke</h2>
  <form id="addJokeForm">
    <textarea id="newJokeContent" rows="5" placeholder="Your joke here..."></textarea>
    <input id="newJokeEmail" type="email" placeholder="Your email (optional)">
    <button type="submit">Submit</button>
  </form>
  <div id="addJokeMessage"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // SUPABASE CONFIG
    
const supabaseUrl = 'https://mknsvxajrvdlwqywvlrf.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rbnN2eGFqcnZkbHdxeXd2bHJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzE5ODIsImV4cCI6MjA4MTA0Nzk4Mn0.2urjAD5bb20Y73ZuWffeyfjDjoj7ISsowMRq9iYm-xo';

    const supabase = createClient(supabaseUrl, supabaseKey);

    const jokeDiv = document.getElementById('joke');
    const metaDiv = document.getElementById('meta');
    const jokeButton = document.getElementById('jokeButton');
    const ratingButtonsDiv = document.getElementById('ratingButtons');
    const ratingStatsDiv = document.getElementById('ratingStats');
    const addJokeForm = document.getElementById('addJokeForm');
    const addJokeMessage = document.getElementById('addJokeMessage');
    const newJokeContent = document.getElementById('newJokeContent');
    const newJokeEmail = document.getElementById('newJokeEmail');

    let allJokes = [];
    let currentJoke = null;

    const ratingOptions = [
      { key: 'rating_dont_get_it_count', label: "I don't get it" },
      { key: 'rating_ehh_count', label: "Ehh" },
      { key: 'rating_good_one_count', label: "Good one" },
      { key: 'rating_fell_off_chair_count', label: "Fell off my chair" }
    ];

    async function loadJokes() {
      const { data, error } = await supabase
        .from('jokes')
        .select('*')
        .eq('is_visible', true)
        .eq('is_flagged', false);

      if (error) {
        jokeDiv.textContent = "Error loading jokes.";
        return;
      }

      allJokes = data;
      showRandom();
    }

    function showRandom() {
      if (allJokes.length === 0) {
        jokeDiv.textContent = "No jokes yet!";
        return;
      }

      currentJoke = allJokes[Math.floor(Math.random() * allJokes.length)];
      displayJoke(currentJoke);
    }

    function displayJoke(joke) {
      jokeDiv.textContent = joke.content;
      metaDiv.textContent = joke.created_at ? "Added: " + new Date(joke.created_at).toLocaleString() : "";
      ratingButtonsDiv.innerHTML = '';
      ratingOptions.forEach(opt => {
        const b = document.createElement('button');
        b.textContent = opt.label;
        b.onclick = () => vote(opt.key);
        ratingButtonsDiv.appendChild(b);
      });
      updateStats(joke);
    }

    function updateStats(joke) {
      const parts = ratingOptions.map(opt => `${opt.label}: ${joke[opt.key]}`);
      ratingStatsDiv.textContent = parts.join(" Â· ");
    }

    async function vote(field) {
      const newVal = (currentJoke[field] || 0) + 1;

      const { data, error } = await supabase
        .from('jokes')
        .update({ [field]: newVal })
        .eq('id', currentJoke.id)
        .select()
        .single();

      if (error) return alert("Error saving vote.");

      // Update local
      currentJoke = data;
      allJokes = allJokes.map(j => j.id === data.id ? data : j);
      displayJoke(currentJoke);
    }

    addJokeForm.addEventListener('submit', async e => {
      e.preventDefault();

      const text = newJokeContent.value.trim();
      const email = newJokeEmail.value.trim();

      if (!text) {
        addJokeMessage.textContent = "Please type a joke.";
        return;
      }

      const { error } = await supabase.from('jokes').insert({
        content: text,
        added_by_email: email || null,
        is_new: true,
        is_visible: true,
        is_flagged: false
      });

      if (error) {
        addJokeMessage.textContent = "Error adding joke.";
      } else {
        addJokeMessage.textContent = "Thank you! Your joke was added.";
        newJokeContent.value = "";
        newJokeEmail.value = "";
        loadJokes();
      }
    });

    jokeButton.onclick = showRandom;
    loadJokes();
  </script>
</body>
</html>

